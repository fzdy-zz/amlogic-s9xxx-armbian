#==========================================================================
# Description: Build Alpine arm64 server image for Amlogic S9xxx devices
#              (Kernel, u-boot, /boot from Armbian style; rootfs from Alpine)
# Copyright (C) 2025-2026 Your Name / forked from ophub/amlogic-s9xxx-armbian
#==========================================================================

name: Build Alpine arm64 image

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      armbian_board:
        description: "Select device board (or group: all, first50, range50_100...)"
        required: false
        default: "s905d"
        type: choice
        options:
          - all
          - first50
          - range50_100
          - range100_150
          - last20
          - a311d-oes_s922x-oes-plus_wxy-oect
          - nsy-g16-plus_nsy-g68-plus_bdy-g18-pro
          - s905d_s905x3_s912_s922x-ct2000
          - a311d
          - a311d-oes
          - alark35-3500
          - anas3035
          - aio-3399b
          - aio-3399c
          - aio-3399c-ai
          - bdkj-bd-one
          - bdy-g18-pro
          - beikeyun
          - chainedbox
          - cm3588-nas
          - crrc
          - dc-a588
          - dg3399
          - dg-tn3568
          - dlfr100
          - e20c
          - e25
          - eaidk-610
          - emb3531
          - fine3399
          - firefly-jd4
          - firefly-rk3399
          - fmx1-pro
          - fmx1-pro-b
          - gzpeite-p01
          - h28k
          - h66k
          - h68k
          - h69k
          - h88k
          - h88k-v3
          - h96-max-m2
          - hs530r
          - hugsun-x99
          - ipc-r
          - jp-tvbox
          - king3399
          - kylin3399
          - lckfb-tspi
          - leez
          - lx-r3s
          - lz-k3568
          - mrkaio-m68s
          - nanopc-t4
          - nanopc-t6
          - nanopi-m5
          - nanopi-r5c
          - nanopi-r5s
          - nsy-g16-plus
          - nsy-g68-plus
          - orangepi-3b
          - orangepi-5-plus
          - orangepi-5b
          - orangepi-zero3
          - panther-x2
          - photonicat
          - r66s
          - r68s
          - renegade-rk3328
          - rk3318-box
          - rock-5-itx
          - rock5b
          - rock5c
          - ruisen-box
          - s905
          - s905-beelink-mini
          - s905-mxqpro-plus
          - s905d
          - s905d-ki-pro
          - s905d-sml5442tw
          - s905l
          - s905l-aurora-1s
          - s905l-b860av21u
          - s905l-mg101
          - s905l2
          - s905l2-e900v21e
          - s905l2-wojia
          - s905l3
          - s905l3-cm211
          - s905l3-unt400g1
          - s905l3-unt402a
          - s905l3a
          - s905l3a-cm311
          - s905l3a-m401a
          - s905l3b
          - s905l3b-e900v21d
          - s905l3b-e900v22d
          - s905l3b-e900v22e
          - s905l3b-ip103h
          - s905l3b-rg020et-ca
          - s905l3b-unt403a
          - s905lb-ipbs9505
          - s905lb-q96-mini
          - s905lb-r3300l
          - s905mb
          - s905w
          - s905w-w95
          - s905w-x96-mini
          - s905w-x96w
          - s905x
          - s905x-b860h
          - s905x-nexbox-a95x
          - s905x-t95
          - s905x-tbee
          - s905x-tx9
          - s905x2
          - s905x2-km3
          - s905x2-x96max-2g
          - s905x2-hg680fj
          - s905x3
          - s905x3-2101
          - s905x3-a100
          - s905x3-a95xf3
          - s905x3-a95xf3-gb
          - s905x3-b
          - s905x3-h96max
          - s905x3-hk1
          - s905x3-ip1001m
          - s905x3-q1
          - s905x3-q2
          - s905x3-tx3
          - s905x3-tx3-bz
          - s905x3-ugoosx3
          - s905x3-whale
          - s905x3-x88-pro-x3
          - s905x3-x96air
          - s905x3-x96air-gb
          - s905x3-x96max
          - s912
          - s912-h96pro-plus
          - s912-m8s-pro
          - s912-nexbox-a1
          - s912-nexbox-a2
          - s912-onecloudpro
          - s912-phicomm-t1
          - s912-t95z-plus
          - s912-tx8-max
          - s912-tx9-pro-2g
          - s912-tx9-pro-3g
          - s912-x92
          - s912-zyxq-fake
          - s922x
          - s922x-ct2000
          - s922x-gtking
          - s922x-gtkingpro-h
          - s922x-odroid-n2
          - s922x-oes-plus
          - s922x-reva
          - s922x-ugoos-am6
          - seewo-sv21
          - smart-am40
          - smart-am60
          - station-m1
          - station-m2
          - station-p2
          - sv-33a6x
          - swan1-w28
          - sw799
          - taram
          - tanix-tx6
          - tb-ls3399
          - tn3399
          - tpm312
          - tqc-a01
          - tvi3315a
          - vplus
          - wocyber-a3
          - wxy-oect
          - wxy-oect-mod
          - xiaobao
          - yskj
          - zcube1-max
          - zk-r39a
          - zysj

      kernel_version:
        description: "Kernel series (auto picks latest in series)"
        required: false
        default: "6.18.y"
        type: choice
        options:
          - 5.10.y
          - 5.15.y
          - 6.1.y
          - 6.6.y
          - 6.12.y
          - 6.18.y
          - 5.10.y_5.15.y
          - 6.1.y_6.6.y
          - 6.12.y_6.18.y
          - 6.1.y_6.12.y
          - 6.1.y_6.18.y

      auto_kernel:
        description: "Auto select latest kernel in chosen series"
        required: false
        default: true
        type: boolean

      rootfs_type:
        description: "Root filesystem type"
        required: false
        default: "ext4"
        type: choice
        options:
          - ext4
          - btrfs

      alpine_release:
        description: "Alpine version branch"
        required: false
        default: "v3.23"
        type: choice
        options:
          - edge
          - v3.23
          - v3.22
          - v3.21

      builder_name:
        description: "Builder signature in image"
        required: false
        default: "alpine-custom"
        type: string

env:
  TZ: Etc/UTC
  ALPINE_ARCH: aarch64
  BUILD_OUTPUT: build/output/images

jobs:
  build:
    runs-on: ubuntu-24.04
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'repository_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get -qq update
          sudo apt-get -y install \
            qemu-user-static binfmt-support debootstrap \
            dosfstools parted fdisk e2fsprogs btrfs-progs \
            wget tar gzip xz-utils pv bc \
            u-boot-tools device-tree-compiler \
            curl git make bc bison flex libssl-dev \
            $(curl -fsSL https://ophub.org/ubuntu2404-build-armbian-depends 2>/dev/null || echo "qemu-utils pigz")
          sudo systemctl daemon-reload
          sudo timedatectl set-timezone "${TZ}"
          date -u
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Expand Actions disk space (loop + LVM)
        if: always()
        run: |
          mnt_size=$(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[A-Za-z.]//g')
          root_size=$(df -h / | tail -1 | awk '{print $4}' | sed 's/[A-Za-z.]//g')
          sudo truncate -s $((${mnt_size}-1))G /mnt/mnt.img
          sudo truncate -s $((${root_size}-4))G /root.img
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          sudo pvcreate /dev/loop6 /dev/loop7
          sudo vgcreate github /dev/loop6 /dev/loop7
          sudo lvcreate -n runner -l 100%FREE github
          sudo mkfs.xfs -f /dev/github/runner
          sudo mkdir -p /builder
          sudo mount /dev/github/runner /builder
          sudo chown -R runner:runner /builder
          df -Th

      - name: Prepare build directories
        working-directory: /builder
        run: |
          mkdir -p kernel u-boot output/images tmp
          ln -sf /builder ${{ github.workspace }}/build
          ln -sf ${{ github.workspace }}/build-armbian build-armbian

      - name: Download latest minirootfs from latest-stable
        working-directory: /builder/tmp
        run: |
          # latest-stable 指向当前稳定分支 (v3.23)
          DIR_URL="https://dl-cdn.alpinelinux.org/alpine/latest-stable/releases/aarch64/"
          
          # 获取目录 HTML，提取所有 alpine-minirootfs-3.23.*-aarch64.tar.gz 文件名
          INDEX=$(curl -s --fail "${DIR_URL}")
          if [[ -z "$INDEX" ]]; then
            echo "Error: Failed to fetch directory listing"
            exit 1
          fi
          
          # 提取文件名，排序取最新（版本号自然排序）
          MINI_FILE=$(echo "$INDEX" | grep -oP 'alpine-minirootfs-3\.[0-9]+\.[0-9]+-aarch64\.tar\.gz' | sort -V | tail -1)
          
          if [[ -z "$MINI_FILE" ]]; then
            echo "Error: No alpine-minirootfs file found in latest-stable"
            exit 1
          fi
          
          ALPINE_URL="${DIR_URL}${MINI_FILE}"
          echo "Detected latest: $MINI_FILE"
          echo "Downloading: $ALPINE_URL"
          
          wget --show-progress "${ALPINE_URL}" -O alpine-minirootfs.tar.gz || exit 1
          mkdir -p rootfs
          tar -xzf alpine-minirootfs.tar.gz -C rootfs/
          ls -lh rootfs/

      - name: Configure Alpine rootfs (chroot)
        working-directory: /builder/tmp
        run: |
          # Mounts (already done)
          sudo mount --bind /dev      rootfs/dev     || true
          sudo mount --bind /proc     rootfs/proc    || true
          sudo mount --bind /sys      rootfs/sys     || true
          sudo mount --bind /run      rootfs/run     || true

          # Critical: DNS resolution (copy host's resolv.conf)
          sudo mkdir -p rootfs/etc
          sudo cp -L /etc/resolv.conf rootfs/etc/resolv.conf || {
            echo "Fallback: using public DNS"
            echo "nameserver 8.8.8.8" | sudo tee rootfs/etc/resolv.conf
            echo "nameserver 1.1.1.1" | sudo tee -a rootfs/etc/resolv.conf
          }

          # Critical: Set up apk repositories (main + community)
          sudo mkdir -p rootfs/etc/apk
          cat << EOF | sudo tee rootfs/etc/apk/repositories
          https://dl-cdn.alpinelinux.org/alpine/${{ inputs.alpine_release }}/main
          https://dl-cdn.alpinelinux.org/alpine/${{ inputs.alpine_release }}/community
          EOF

          # Now chroot and configure
          sudo chroot rootfs /bin/sh <<'CHROOT'
            # Update index first (now should work)
            apk update

            # Install base packages (including openrc for rc-update)
            apk add --no-cache \
              alpine-base openrc busybox-initscripts \
              bash coreutils shadow sudo util-linux \
              openssh-server linux-firmware \
              e2fsprogs btrfs-progs dosfstools parted \
              tar grep sed gawk findutils tzdata

            # Enable services (now rc-update exists)
            rc-update add sshd default
            rc-update add networking default
            rc-update add crond default
            rc-update add syslog boot

            # Users & security
            echo "root:alpine" | chpasswd
            adduser -D -s /bin/ash user
            echo "user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

            # Timezone & welcome files
            ln -sf /usr/share/zoneinfo/UTC /etc/localtime
            echo "Alpine Linux (${{ inputs.alpine_release }}) - Amlogic TV Box" > /etc/motd
            echo "Alpine on Amlogic" > /etc/issue

            # SSH
            mkdir -p /etc/ssh
            sed -i 's/^#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config || true

            # Clean cache
            apk cache clean
          CHROOT

          # Cleanup mounts
          sudo umount -l rootfs/{dev,proc,sys,run} 2>/dev/null || true
          ls -lh rootfs/etc/apk/ rootfs/etc/resolv.conf  # debug

      - name: Run rebuild-alpine script
        working-directory: ${{ github.workspace }}
        env:
          BOARD: ${{ inputs.armbian_board }}
          KERNEL: ${{ inputs.kernel_version }}
          FSTYPE: ${{ inputs.rootfs_type }}
          AUTO_KERNEL: ${{ inputs.auto_kernel }}
          BUILDER: ${{ inputs.builder_name }}
        run: |
          chmod +x rebuild-alpine.sh || chmod +x rebuild  # fallback if you renamed
          sudo ./rebuild-alpine.sh \
            -b "${BOARD}" \
            -k "${KERNEL}" \
            -t "${FSTYPE}" \
            -a "${AUTO_KERNEL}" \
            -n "${BUILDER}" \
            --rootfs-path "/builder/tmp/rootfs"

      - name: Upload built images
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: alpine-amlogic-images
          path: |
            /builder/output/images/*.img
            /builder/output/images/*.img.gz
            /builder/output/images/*.img.xz
          retention-days: 7
          compression-level: 6

      - name: Show disk usage summary
        if: always()
        run: df -hT && ls -lh /builder/output/images/
